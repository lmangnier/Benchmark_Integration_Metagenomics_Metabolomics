#!/usr/bin/env Rscript
#This script executes the CODA-LASSO returning results and associated taxa
#The script takes a data as generated by code_simulation*.R 

args = commandArgs(trailingOnly=TRUE)

library(coda4microbiome)

apply_nzv_filter <- function(x, freqCut = 95/5, uniqueCut = 10){
  nzv <- mixOmics::nearZeroVar(x = x, freqCut = freqCut, uniqueCut = uniqueCut)
  if(length(nzv$Position) > 0) x <- x[, -nzv$Position]
  return(x)}


data = args[1]

data = readRDS(data)

coda.LASSO.results = lapply(1:length(data), function(rep){
        print(rep)
        species = data[[rep]]$Simulated.Microbiotes
        metabolites = data[[rep]]$Simulated.Metabolites #Log transformation should be considered

        colnames(species) = paste0("Micro", 1:ncol(species))
        colnames(metabolites) = paste0("Metabo", 1:ncol(metabolites))

        species = apply_nzv_filter(species)
        metabolites = apply_nzv_filter(metabolites)

        taxa_num = lapply(1:ncol(metabolites), function(col){
                t = tryCatch(coda_glmnet(x = species, y = metabolites[,col] ,alpha=1,showPlots=FALSE)$taxa.num,  error=function(err) NA)
		t
})
        return(taxa_num)
})

saveRDS(coda.LASSO.results, "results_CODA_LASSO.RDS")
